<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>浏览器安全周报 2019.10.21 - 2019.10.25 | wnagzihxa1n’s blog</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="浏览器安全周报 2019.10.21 - 2019.10.25" />
<meta name="author" content="wnagzihxa1n" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="有段时间没有更新浏览器了" />
<meta property="og:description" content="有段时间没有更新浏览器了" />
<link rel="canonical" href="http://localhost:4000/2019/10/25/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%AE%89%E5%85%A8%E5%91%A8%E6%8A%A5-2019.10.21-2019.10.25.html" />
<meta property="og:url" content="http://localhost:4000/2019/10/25/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%AE%89%E5%85%A8%E5%91%A8%E6%8A%A5-2019.10.21-2019.10.25.html" />
<meta property="og:site_name" content="wnagzihxa1n’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-10-25T20:40:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="浏览器安全周报 2019.10.21 - 2019.10.25" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"wnagzihxa1n"},"headline":"浏览器安全周报 2019.10.21 - 2019.10.25","dateModified":"2019-10-25T20:40:00+08:00","@type":"BlogPosting","description":"有段时间没有更新浏览器了","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2019/10/25/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%AE%89%E5%85%A8%E5%91%A8%E6%8A%A5-2019.10.21-2019.10.25.html"},"datePublished":"2019-10-25T20:40:00+08:00","url":"http://localhost:4000/2019/10/25/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%AE%89%E5%85%A8%E5%91%A8%E6%8A%A5-2019.10.21-2019.10.25.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="wnagzihxa1n's blog" /></head>
<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">wnagzihxa1n&#39;s blog<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        <a class="color-cyan-hover" href="https://twitter.com/wnagzihxa1n"><i class="fab fa-twitter-square"></i></a><a class="color-purple-hover" href="https://github.com/wnagzihxa1n"><i class="fab fa-github-square"></i></a>
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        
  <div class="author-box">
    
    <img src="/assets/HeadIcon.jpg" class="author-avatar" alt="Avatar" />
I am wnagzihxa1n, an unknown iOS/Android security researcher, this blog is my security study notes, just share something interesting.

</div>


<div class="post">
  <h1 class="post-title">浏览器安全周报 2019.10.21 - 2019.10.25</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/browser_security/">browser_security</a>
      
  </div>
  
  <div class="post-date">Published on 25 Oct 2019</div>
  
  <p>有段时间没有更新浏览器了</p>

<p>JS Fuzz，有点意思，我还没有看源码</p>
<ul>
  <li>https://github.com/fuzzitdev/jsfuzz</li>
</ul>

<p>最近分析了CRBUG-944971，对应的CVE编号是CVE-2019-13698，正则模块的漏洞</p>
<ul>
  <li>https://bugs.chromium.org/p/chromium/issues/detail?id=944971</li>
</ul>

<p>触发漏洞的原理很简单，根据报告者的Exp去找漏洞的触发路径很有意思</p>

<p>首先正则的Replace函数认为传入的是未经修改的对象，也就是说没有被重新定义过的正则对象，它会调用<code class="language-plaintext highlighter-rouge">ToString()</code>，这是一个可以在上层进行定义的函数</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>V8_WARN_UNUSED_RESULT MaybeHandle&lt;String&gt; RegExpReplace(Isolate* isolate, Handle&lt;JSRegExp&gt; regexp, Handle&lt;String&gt; string, Handle&lt;Object&gt; replace_obj) {
    // Functional fast-paths are dispatched directly by replace builtin.
    DCHECK(RegExpUtils::IsUnmodifiedRegExp(isolate, regexp));
    DCHECK(!replace_obj-&gt;IsCallable());

    Factory* factory = isolate-&gt;factory();

    const int flags = regexp-&gt;GetFlags();
    const bool global = (flags &amp; JSRegExp::kGlobal) != 0;
    const bool sticky = (flags &amp; JSRegExp::kSticky) != 0;

    Handle&lt;String&gt; replace;
    ASSIGN_RETURN_ON_EXCEPTION(isolate, replace, Object::ToString(isolate, replace_obj), String); &lt;== 1
    replace = String::Flatten(isolate, replace);
</code></pre></div></div>

<p>官方给的回归测试文件可以看到就是在<code class="language-plaintext highlighter-rouge">toString()</code>里进行操作</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>let re = /x/y;
let cnt = 0;
let str = re[Symbol.replace]("x", {
    toString: () =&gt; {
        cnt++;
        if (cnt == 2) {
            re.lastIndex = {valueOf: () =&gt; {
                re.x = 42;
                return 0;
            }};
        }
        return 'y$';
    }
});
assertEquals("y$", str);
</code></pre></div></div>

<p>具体这个漏洞的利用细节我会单独写一篇文章分析，周报里简单讲讲，首先我们使用下面的代码测试一个特性</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var pattern = new RegExp("AA","g");
%DebugPrint(pattern);

pattern.__defineGetter__('x', ()=&gt;2);
%DebugPrint(pattern);

pattern.__defineGetter__('x', ()=&gt;2);
%DebugPrint(pattern);

while(true);
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">%DebugPrint</code>是V8调试版本下一个用于打印对象的接口，输出的数据我简化一下，第二次<code class="language-plaintext highlighter-rouge">__defineGetter__</code>执行完后，可以看到<code class="language-plaintext highlighter-rouge">lastIndex</code>被移动到<code class="language-plaintext highlighter-rouge">properties</code>存储，同时对象长度减少8字节</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DebugPrint: 0x1fb102d4dcc1: [JSRegExp]
 - map: 0x1d23bf341359 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]
 - properties: 0x1878b9400c71 &lt;FixedArray[0]&gt; {
    #lastIndex: 0 (data field 0)
 }
0x1d23bf341359: [Map]
 - type: JS_REGEXP_TYPE
 - instance size: 56

------------------------------------------------------------

DebugPrint: 0x1fb102d4dcc1: [JSRegExp]
 - map: 0x1d23bf34a9f9 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]
 - properties: 0x1878b9400c71 &lt;FixedArray[0]&gt; {
    #lastIndex: 0 (data field 0)
    #x: 0x2d807e95f4c1 &lt;AccessorPair&gt; (const accessor descriptor)
 }
0x1d23bf34a9f9: [Map]
 - type: JS_REGEXP_TYPE
 - instance size: 56

------------------------------------------------------------

DebugPrint: 0x1fb102d4dcc1: [JSRegExp]
 - map: 0x1d23bf34aa49 &lt;Map(HOLEY_ELEMENTS)&gt; [DictionaryProperties]
 - properties: 0x1fb102d4f631 &lt;NameDictionary[29]&gt; {
   #lastIndex: 0 (data, dict_index: 1, attrs: [W__])
   #x: 0x2d807e95f4d9 &lt;AccessorPair&gt; (accessor, dict_index: 2, attrs: [WEC])
 }
0x1d23bf34aa49: [Map]
 - type: JS_REGEXP_TYPE
 - instance size: 48
</code></pre></div></div>

<p>记住上面的这点，我们来看内存角度</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var pattern = new RegExp("AA","g");
gdb-peda$ x/20gx 0x99f7870dcd8
0x99f7870dcd8:	0x000030b004981359	0x00003df557b80c71
0x99f7870dce8:	0x00003df557b80c71	0x0000099f7870f561
0x99f7870dcf8:	0x000000a31509f099	0x0000000100000000
0x99f7870dd08:	0x0000000000000000	0x00003df557b808a1

以下因为重新运行导致内存地址变化，问题不大，两次执行过后可以看到核心的地方出现了，注意箭头指向的地方，原先是`0`，现在变成了一个地址
pattern.__defineGetter__('x', ()=&gt;2);
pattern.__defineGetter__('x', ()=&gt;2);
gdb-peda$ x/20gx 0x30e12f60dce0
0x30e12f60dce0:	0x0000365cc160aa49	0x000030e12f60f651
0x30e12f60dcf0:	0x00003cb956540c71	0x000030e12f60f569
0x30e12f60dd00:	0x00000d083935f099	0x0000000100000000
0x30e12f60dd10:	0x00003cb956540321 &lt;==	0x00003cb9565408a1
0x30e12f60dd20:	0x0000018300000000	0x0000000100000000
0x30e12f60dd30:	0x0000000000000000	0x0000008000000000
0x30e12f60dd40:	0x00003cb9565404d1	0x00003cb9565404d1
0x30e12f60dd50:	0x00003cb9565404d1	0x00003cb9565404d1
0x30e12f60dd60:	0x00003cb9565404d1	0x00003cb9565404d1
0x30e12f60dd70:	0x00003cb9565404d1	0x00003cb9565404d1
</code></pre></div></div>

<p>我们通过<code class="language-plaintext highlighter-rouge">job</code>命令查看，它是一个对象的Map，也就是说，这里是一个新的对象内存空间</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ job 0x00003cb956540321
0x3cb956540321: [Map]
 - type: FILLER_TYPE
 - instance size: 8
 - elements kind: HOLEY_ELEMENTS
 - unused property fields: 0
 - enum length: invalid
 - stable_map
 - back pointer: 0x3cb9565404d1 &lt;undefined&gt;
 - prototype_validity cell: 0
 - instance descriptors (own) #0: 0x3cb956540259 &lt;DescriptorArray[0]&gt;
 - layout descriptor: (nil)
 - prototype: 0x3cb9565401d9 &lt;null&gt;
 - constructor: 0x3cb9565401d9 &lt;null&gt;
 - dependent code: 0x3cb9565402c1 &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;
 - construction counter: 0
</code></pre></div></div>

<p>这个特性有什么用呢？</p>

<p>我们再回到<code class="language-plaintext highlighter-rouge">Replace</code>函数里，它竟然可以直接设置这个<code class="language-plaintext highlighter-rouge">lastIndex</code>位，也就是说，在<code class="language-plaintext highlighter-rouge">Replace</code>里处理的时候，可以通过<code class="language-plaintext highlighter-rouge">toString()</code>修改掉这个值，而修改的时候，原先的<code class="language-plaintext highlighter-rouge">lastIndex</code>已经变成了另一个对象的<code class="language-plaintext highlighter-rouge">Map</code>，这就造成了一个越界写操作，<code class="language-plaintext highlighter-rouge">sticky</code>对应的<code class="language-plaintext highlighter-rouge">y</code>，比如<code class="language-plaintext highlighter-rouge">"AA/y"</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (match_indices_obj-&gt;IsNull(isolate)) {
    if (sticky) regexp-&gt;set_last_index(Smi::kZero, SKIP_WRITE_BARRIER);
        return string;
}

auto match_indices = Handle&lt;RegExpMatchInfo&gt;::cast(match_indices_obj);

const int start_index = match_indices-&gt;Capture(0);
const int end_index = match_indices-&gt;Capture(1);

if (sticky) {
    regexp-&gt;set_last_index(Smi::FromInt(end_index), SKIP_WRITE_BARRIER);
}
</code></pre></div></div>

<p>参加了今年的数字校招面试工作，一共是四批，第一批是内推，剩下三批是大流程，内推的好处就是万一挂了可以参加大流程，完全不会有影响，但是大流程只能参加一次</p>

<p>整个部门的候选人简历一眼刷下来几乎全是硕士学历，本科生屈指可数，全公司的比例情况我不清楚，没有看到表格</p>

<p>感慨还好毕业的早，不然今年可能真的找不到工作了</p>

<p>记得17年的春招，我在寝室里参加了数字的春招视频面试，大早上有个人打电话给我问我能不能参加面试，然后我就早早地在那里准备了，然后时间一到就有面试官Call我，一早上三面聊得很快，一面工程师，二面leader，三面HR</p>

<p>另外，今年的秋招差不多结束了，春招的时候大家投简历请踊跃一点，不要太羞涩了，有坑，缺人！需要内推360的后台联系我啊！！！！！！</p>

</div>


<div class="comments">
<div id="disqus_thread"></div>
<script>
 var disqus_config = function () {
     this.page.url = 'http://localhost:4000/2019/10/25/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%AE%89%E5%85%A8%E5%91%A8%E6%8A%A5-2019.10.21-2019.10.25.html';
     this.page.identifier = '/2019/10/25/浏览器安全周报 2019.10.21 - 2019.10.25';
     this.page.title = '浏览器安全周报 2019.10.21 - 2019.10.25';
 };

 (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
     var d = document, s = d.createElement('script');

     s.src = '//wnagzihxa1n-github-io.disqus.com/embed.js';

     s.setAttribute('data-timestamp', +new Date());
     (d.head || d.body).appendChild(s);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

</div>




<div class="related">
  <h2>related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2021/01/22/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2021.01.22.html">
            大土豆安全笔记 2021.01.22 在线求团购*OS Internals III
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2021/01/15/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2021.01.15.html">
            大土豆安全笔记 2021.01.15 您已本分
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2021/01/08/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2021.01.08.html">
            大土豆安全笔记 2021.01.08 我，零基础，学iOS macOS安全
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>all tags</h2>
  <div class="tag-cloud"><a href="/tag/android_application_security/" class="set-1">android_application_security</a> <a href="/tag/android_ctf/" class="set-3">android_ctf</a> <a href="/tag/browser_security/" class="set-4">browser_security</a> <a href="/tag/security_daily/" class="set-5">security_daily</a></div>
  




<script>
  let i = 0;
  const text = '';
  const speed = parseInt('50');
  
  function typeWriter() {
    if (i < text.length) {
      document.getElementById('animated-post-description').innerHTML += text.charAt(i);
      i++;
      setTimeout(typeWriter, speed);
    }
  }

  document.getElementById('animated-post-description').style.display = 'initial';
  typeWriter();
</script>

      </div>
    </main><footer class="site-footer">
  <div class="wrapper">
    <div class="credits"><div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked />
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
const theme = localStorage.getItem('theme');

if (theme === "light") {
    document.documentElement.setAttribute('data-theme', 'light');
} else {
    document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

function activateDarkTheme() {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
	window.localStorage.setItem('theme', 'dark');
}

function activateLightTheme() {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
	window.localStorage.setItem('theme', 'light');
}

if (theme === "dark") {
    activateDarkTheme();
} else if (theme === "light") {
    activateLightTheme();
} else if  (userPrefers === "light") {
    activateDarkTheme();
} else {
    activateDarkTheme();
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    activateLightTheme();
	} else {
	    activateDarkTheme();
	}
}
</script></div>
  </div>
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
