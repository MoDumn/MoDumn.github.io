<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>大土豆安全笔记 2020.04.20 | wnagzihxa1n’s blog</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="大土豆安全笔记 2020.04.20" />
<meta name="author" content="wnagzihxa1n" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="这篇文章会涉及一些基础的图论名词，但都简单易懂，且只聊思路，并不涉及太多的代码，请放心阅读" />
<meta property="og:description" content="这篇文章会涉及一些基础的图论名词，但都简单易懂，且只聊思路，并不涉及太多的代码，请放心阅读" />
<link rel="canonical" href="http://localhost:4000/2020/04/20/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2020.04.20.html" />
<meta property="og:url" content="http://localhost:4000/2020/04/20/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2020.04.20.html" />
<meta property="og:site_name" content="wnagzihxa1n’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-04-20T20:40:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="大土豆安全笔记 2020.04.20" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"wnagzihxa1n"},"headline":"大土豆安全笔记 2020.04.20","dateModified":"2020-04-20T20:40:00+08:00","@type":"BlogPosting","description":"这篇文章会涉及一些基础的图论名词，但都简单易懂，且只聊思路，并不涉及太多的代码，请放心阅读","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/04/20/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2020.04.20.html"},"datePublished":"2020-04-20T20:40:00+08:00","url":"http://localhost:4000/2020/04/20/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2020.04.20.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="wnagzihxa1n's blog" /></head>
<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">wnagzihxa1n&#39;s blog<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        <a class="color-cyan-hover" href="https://twitter.com/wnagzihxa1n"><i class="fab fa-twitter-square"></i></a><a class="color-purple-hover" href="https://github.com/wnagzihxa1n"><i class="fab fa-github-square"></i></a>
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        
  <div class="author-box">
    
    <!-- 
        <img src="/assets/HeadIcon.jpg" class="author-avatar" alt="Avatar" />
     -->
I am wnagzihxa1n, an unknown iOS/Android security researcher, this blog is my security study notes, just share something interesting.

</div>


<div class="post">
  <h1 class="post-title">大土豆安全笔记 2020.04.20</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/security_daily/">security_daily</a>
      
  </div>
  
  <div class="post-date">Published on 20 Apr 2020</div>
  
  <p>这篇文章会涉及一些基础的图论名词，但都简单易懂，且只聊思路，并不涉及太多的代码，请放心阅读</p>

<p>周末做了两件事</p>
<ol>
  <li>优化了Neo4j的搜索逻辑</li>
  <li>在李神探的指导下，很快跑通了FlowDroid</li>
</ol>

<p>先讲讲Neo4j的搜索，用AndroGuard生成函数调用图，这个图是以<code class="language-plaintext highlighter-rouge">node</code>和<code class="language-plaintext highlighter-rouge">edge</code>的形式存储在GML文件里，表示形式如下</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node [
    id 143
    label "Lcom/wnagzihxa1n/myapplication/MainActivity;-&gt;onCreate(Landroid/os/Bundle;)V [access_flags=protected] @ 0x10a98"
    external False
    entrypoint True
]

node [
    id 144
    label "Lcom/wnagzihxa1n/myapplication/MainActivity;-&gt;startActivity(Landroid/content/Intent;)V"
    external True
    entrypoint True
]

edge [
    source 143
    target 144
]
</code></pre></div></div>

<p>这就表示了从节点<code class="language-plaintext highlighter-rouge">143</code>到节点<code class="language-plaintext highlighter-rouge">144</code>有一条边，这些节点和边的定义构成了一个有向图</p>

<p>我们只需要解析GML文件，将节点和边导入Neo4j数据库，再进行路径搜索即可</p>

<p>效果还是很好的</p>

<p><img src="/assets/resources/FE523B0E24B64601FB9FC22FDE156A99.jpg" alt="IMAGE" /></p>

<p>为什么我一开始说的是优化搜索逻辑呢？</p>

<p>因为这些工作其实早就做完了，并不是周末做的，上面的搜索相当耗时，单位都是小时来计算，我看看弄一台服务器来跑</p>

<p>在图够准确的情况下，我将两个小时的搜索压缩到了一分钟以内</p>

<p><strong>优化一</strong></p>

<p>首先我们将GML重写，将所有节点解析成一行，然后申请内存，此处用C语言写，将数据存储在内存里，用结构体存储节点，并且我们只需要<code class="language-plaintext highlighter-rouge">id</code>和<code class="language-plaintext highlighter-rouge">label</code>两个结构体成员</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node [ id 0 label "Landroidx/activity/R$attr;-&gt;&lt;init&gt;()V [access_flags=private constructor] @ 0xe4e4" ]
node [ id 1 label "Ljava/lang/Object;-&gt;&lt;init&gt;()V" ]
node [ id 2 label "Landroidx/activity/R$color;-&gt;&lt;init&gt;()V [access_flags=private constructor] @ 0xe4fc" ]
node [ id 3 label "Landroidx/activity/R$dimen;-&gt;&lt;init&gt;()V [access_flags=private constructor] @ 0xe514" ]
</code></pre></div></div>

<p>将所有节点写入内存，这里小几十万个节点写入堆完全没问题的</p>

<p>但是这里的写，并不是随便申请堆空间吭哧吭哧就往里面写，而是利用偏移存储</p>

<p>我们在进行GML重写的时候大概计算一下所有<code class="language-plaintext highlighter-rouge">label</code>字段拼接的长度，有了这一长度数据，我们就可以在堆空间申请的时候有一个大概的参考</p>

<p>申请<code class="language-plaintext highlighter-rouge">label</code>堆空间之后，我们申请所有<code class="language-plaintext highlighter-rouge">Node</code>结构体的堆空间，都申请好之后，开始写入数据</p>

<p>这里我们将结构体的概念去除，完全靠偏移，从<code class="language-plaintext highlighter-rouge">Node</code>结构体的堆首地址开始往下写，使用一个额外的读指针指向<code class="language-plaintext highlighter-rouge">label</code>堆空间</p>

<p>第一个Node：写入第一个节点的<code class="language-plaintext highlighter-rouge">id</code>，第二个字段是<code class="language-plaintext highlighter-rouge">label</code>堆空间的首地址，写完<code class="language-plaintext highlighter-rouge">label</code>堆空间将指针挪动，并且记录堆地址起点</p>

<p>第二个Node：写入第二个节点的<code class="language-plaintext highlighter-rouge">id</code>，第二个字段直接赋值为上面记录的新堆地址起点，重复上面的挪动过程</p>

<p>后面的节点按照上面的操作记录即可</p>

<p>此时我们分割<code class="language-plaintext highlighter-rouge">Node</code>结构体的堆空间，长度按照大家的运行平台计算，但是每个结构体所占用的长度肯定是固定的</p>

<p>比如我这里需要获取<code class="language-plaintext highlighter-rouge">id</code>为1000的结构体，那么从<code class="language-plaintext highlighter-rouge">Node</code>结构体堆空间起始地址开始，算上一千个结构体长度，就是我们需要的节点，对其进行取值即可，这是我用来存储的方式</p>

<p><strong>优化二</strong></p>

<p>实践过的同学都会发现一个问题，就是冗余的节点和边实在是太多了，又用不到，徒增性能开销</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node [ id 0 label "Landroidx/activity/R$attr;-&gt;&lt;init&gt;()V [access_flags=private constructor] @ 0xe4e4" ]
node [ id 1 label "Ljava/lang/Object;-&gt;&lt;init&gt;()V" ]
node [ id 2 label "Landroidx/activity/R$color;-&gt;&lt;init&gt;()V [access_flags=private constructor] @ 0xe4fc" ]
node [ id 3 label "Landroidx/activity/R$dimen;-&gt;&lt;init&gt;()V [access_flags=private constructor] @ 0xe514" ]
node [ id 4 label "Landroidx/activity/R$drawable;-&gt;&lt;init&gt;()V [access_flags=private constructor] @ 0xe52c" ]
node [ id 5 label "Landroidx/activity/R$id;-&gt;&lt;init&gt;()V [access_flags=private constructor] @ 0xe544" ]
node [ id 6 label "Landroidx/activity/R$integer;-&gt;&lt;init&gt;()V [access_flags=private constructor] @ 0xe55c" ]
node [ id 7 label "Landroidx/activity/R$layout;-&gt;&lt;init&gt;()V [access_flags=private constructor] @ 0xe574" ]
node [ id 8 label "Landroidx/activity/R$string;-&gt;&lt;init&gt;()V [access_flags=private constructor] @ 0xe58c" ]
node [ id 9 label "Landroidx/activity/R$style;-&gt;&lt;init&gt;()V [access_flags=private constructor] @ 0xe6d0" ]
node [ id 10 label "Landroidx/activity/R$styleable;-&gt;&lt;init&gt;()V [access_flags=private constructor] @ 0xe6b8" ]
node [ id 11 label "Landroidx/activity/R;-&gt;&lt;init&gt;()V [access_flags=private constructor] @ 0xe6e8" ]
</code></pre></div></div>

<p>既然重写，那就重写的更彻底一些，我决定缩点，这里的缩点并非图论里的缩点，但是思想类似</p>

<p>我这里的缩点有两步</p>
<ol>
  <li>将入度和出度都为0的节点优化掉</li>
  <li>将<code class="language-plaintext highlighter-rouge">系统库内调用</code>的节点优化掉</li>
</ol>

<p>第一个缩点很好理解，有向图的节点入度和出度都为0表示没有边，没有边的节点表示没有调用，直接删除</p>

<p>第二个缩点我们以代码来看，节点<code class="language-plaintext highlighter-rouge">7093</code>指向了节点<code class="language-plaintext highlighter-rouge">7010</code>，系统库内的调用对我们来说是没有意义的，所以我们可以进行动态标记，先将所有的边遍历一遍，把系统库内函数为<code class="language-plaintext highlighter-rouge">source</code>的边，全部删除</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node [
    id 7093
    label "Landroid/support/v4/provider/TreeDocumentFile;-&gt;createDirectory(Ljava/lang/String;)Landroid/support/v4/provider/DocumentFile; [access_flags=public] @ 0x1ca25c"
    external False
    entrypoint False
]
  
node [
    id 7010
    label "Landroid/support/v4/provider/TreeDocumentFile;-&gt;&lt;init&gt;(Landroid/support/v4/provider/DocumentFile; Landroid/content/Context; Landroid/net/Uri;)V [access_flags=constructor] @ 0x1ca1f4"
    external False
    entrypoint False
]
  
edge [
    source 7093
    target 7010
]
</code></pre></div></div>

<p>这里是否有例外呢？我还不能肯定，还请师傅们指点</p>

<p>补充有向图的三个概念</p>

<p>强连通：有向图G存在节点A和节点B，节点A有一条路径可以到达节点B，节点B有一条路径可以到达节点A，就叫作两个节点强连通</p>

<p>强连通图：有向图G中任意两个节点都强连通，就叫作强连通图</p>

<p>强连通分量：有向图G中有一个子图，这个子图满足任意两个节点强连通，就叫作强连通分量</p>

<p>有向图的缩点是指求出有向图G所有强连通分量之后，将每一个强连通分量以一个节点的形式来表示，重构有向图G的过程</p>

<p>思路我已经抛出来了，大家可以思考下是否能通过图论里的缩点思想，来实现路径搜索优化呢？</p>

<p><strong>优化三</strong></p>

<p>此时我们就可以开始构建图了，这个优化我先不说，而我用了什么方法，我相信聪明的读者看到我上面的存储方式，就已经猜到了:)</p>

<p>上面为什么我说”图够准确”呢？</p>

<p>因为安卓平台的应用存在大量的回调操作，比如控件<code class="language-plaintext highlighter-rouge">Button</code>的点击事件，而<code class="language-plaintext highlighter-rouge">AndroGuard</code>默认并未生成绑定监听相关的<code class="language-plaintext highlighter-rouge">edge</code>，这就造成了可能的误报和漏报</p>

<p>来看一个通过按钮点击跳转Activity的例子</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protected void onCreate(Bundle bundle) {
    super.onCreate(bundle);
    
    ...
    
    v0_3.setOnClickListener(new bc(this));  // 此处绑定点击事件回调
    
    ...
}

final class bc implements View$OnClickListener {
    bc(SelectVideoActivity argActivity) {
        this.activity = argActivity;
        super();
    }

    public final void onClick(View view) {
        Intent intent = new Intent();
        intent.setClass(this.activity, SearchPagerActivity.class);
        this.activity.startActivity(intent);
        MTAReport.reportUserEvent("video_jce_circle_search_btn", new String[0]);
    }
}
</code></pre></div></div>

<p>对应的GML文件相关数据如下，可以看到有<code class="language-plaintext highlighter-rouge">onClick()</code>指向<code class="language-plaintext highlighter-rouge">startActivity()</code>的边，但是却没有指向回调函数的边</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node [
    id 107682
    label "Lcom/tencent/qqlive/ona/circle/activity/SelectVideoActivity;-&gt;onCreate(Landroid/os/Bundle;)V [access_flags=protected] @ 0x6047ac"
    external False
    entrypoint True
]

node [
    id 107914
    label "Lcom/tencent/qqlive/ona/circle/activity/bc;-&gt;onClick(Landroid/view/View;)V [access_flags=public final] @ 0x607c5c"
    external False
    entrypoint False
]

node [
    id 107697
    label "Lcom/tencent/qqlive/ona/circle/activity/SelectVideoActivity;-&gt;startActivity(Landroid/content/Intent;)V"
    external True
    entrypoint True
]

edge [
    source 107914
    target 107697
]
</code></pre></div></div>

<p>对于这种问题，我决定自己优化<code class="language-plaintext highlighter-rouge">AndroGuard</code>的生成结果</p>

<p>上面这个例子对应的Smali代码如下，JEB和APKTool的结果略有出入，但不影响分析，可以看到调用关系还是很清晰的</p>

<p><img src="/assets/resources/19A07B80C6DC715C12AB9A4B7D05698D.jpg" alt="IMAGE" /></p>

<p>我们最后处理的时候以APKTool反编译的Smali代码为准，我们不用关心这个点击事件回调绑定的哪个控件，只要存在，就把这条边记录下来</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.line 1167
new-instance v1, Lcom/tencent/qqlive/ona/circle/activity/bc;

invoke-direct {v1, p0}, Lcom/tencent/qqlive/ona/circle/activity/bc;-&gt;&lt;init&gt;(Lcom/tencent/qqlive/ona/circle/activity/SelectVideoActivity;)V

invoke-virtual {v0, v1}, Landroid/view/View;-&gt;setOnClickListener(Landroid/view/View$OnClickListener;)V
</code></pre></div></div>

<p>路漫漫其修远兮，这是一项体力活</p>

<p>FlowDroid的工作说起来可就优雅多了</p>

<p>从官方的仓库获取代码，配置两个环境变量，然后<code class="language-plaintext highlighter-rouge">mvn install</code>就行了，虽然会有若干错误，还是比较容易解决的</p>

<p>中间最关键的一步就是切换到<code class="language-plaintext highlighter-rouge">master</code>分支，要解决的错误少多了</p>

<p>接下来我就投入精力到与FlowDroid运行效率作斗争的工作中</p>

<p>就如同李神探所说，如果能够在已有FlowDroid框架上进行优化到一分钟，都可以发Paper了</p>

<p>所以说当别人提出一些想法的时候，不要着急否定，你怎么知道我一口吃不成个大胖子呢？</p>

<p>有时候不多认识些优秀的同龄人，都不知道自己原来这么弱</p>

</div>


<div class="comments">
<div id="disqus_thread"></div>
<script>
 var disqus_config = function () {
     this.page.url = 'http://localhost:4000/2020/04/20/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2020.04.20.html';
     this.page.identifier = '/2020/04/20/大土豆安全笔记 2020.04.20';
     this.page.title = '大土豆安全笔记 2020.04.20';
 };

 (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
     var d = document, s = d.createElement('script');

     s.src = '//wnagzihxa1n-github-io.disqus.com/embed.js';

     s.setAttribute('data-timestamp', +new Date());
     (d.head || d.body).appendChild(s);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

</div>




<div class="related">
  <h2>related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2021/01/22/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2021.01.22.html">
            大土豆安全笔记 2021.01.22 在线求团购*OS Internals III
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2021/01/15/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2021.01.15.html">
            大土豆安全笔记 2021.01.15 您已本分
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2021/01/08/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2021.01.08.html">
            大土豆安全笔记 2021.01.08 我，零基础，学iOS macOS安全
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>all tags</h2>
  <div class="tag-cloud"><a href="/tag/android_application_security/" class="set-1">android_application_security</a> <a href="/tag/android_ctf/" class="set-3">android_ctf</a> <a href="/tag/browser_security/" class="set-4">browser_security</a> <a href="/tag/security_daily/" class="set-5">security_daily</a></div>
  




<script>
  let i = 0;
  const text = '';
  const speed = parseInt('50');
  
  function typeWriter() {
    if (i < text.length) {
      document.getElementById('animated-post-description').innerHTML += text.charAt(i);
      i++;
      setTimeout(typeWriter, speed);
    }
  }

  document.getElementById('animated-post-description').style.display = 'initial';
  typeWriter();
</script>

      </div>
    </main><footer class="site-footer">
  <div class="wrapper">
    <div class="credits"><div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked />
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
const theme = localStorage.getItem('theme');

if (theme === "light") {
    document.documentElement.setAttribute('data-theme', 'light');
} else {
    document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

function activateDarkTheme() {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
	window.localStorage.setItem('theme', 'dark');
}

function activateLightTheme() {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
	window.localStorage.setItem('theme', 'light');
}

if (theme === "dark") {
    activateDarkTheme();
} else if (theme === "light") {
    activateLightTheme();
} else if  (userPrefers === "light") {
    activateDarkTheme();
} else {
    activateDarkTheme();
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    activateLightTheme();
	} else {
	    activateDarkTheme();
	}
}
</script></div>
  </div>
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
