<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>大土豆安全笔记 2020.07.17 OPPO的移动安全团队很不错 | wnagzihxa1n’s blog</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="大土豆安全笔记 2020.07.17 OPPO的移动安全团队很不错" />
<meta name="author" content="wnagzihxa1n" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="我最近学习到一个新姿势，在Android应用里进行XSS攻击" />
<meta property="og:description" content="我最近学习到一个新姿势，在Android应用里进行XSS攻击" />
<link rel="canonical" href="http://localhost:4000/2020/07/17/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2020.07.17.html" />
<meta property="og:url" content="http://localhost:4000/2020/07/17/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2020.07.17.html" />
<meta property="og:site_name" content="wnagzihxa1n’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-17T20:40:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="大土豆安全笔记 2020.07.17 OPPO的移动安全团队很不错" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"wnagzihxa1n"},"headline":"大土豆安全笔记 2020.07.17 OPPO的移动安全团队很不错","dateModified":"2020-07-17T20:40:00+08:00","@type":"BlogPosting","description":"我最近学习到一个新姿势，在Android应用里进行XSS攻击","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/07/17/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2020.07.17.html"},"datePublished":"2020-07-17T20:40:00+08:00","url":"http://localhost:4000/2020/07/17/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2020.07.17.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="wnagzihxa1n's blog" /></head>
<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">wnagzihxa1n&#39;s blog<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        <a class="color-cyan-hover" href="https://twitter.com/wnagzihxa1n"><i class="fab fa-twitter-square"></i></a><a class="color-purple-hover" href="https://github.com/wnagzihxa1n"><i class="fab fa-github-square"></i></a>
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        
  <div class="author-box">
    
    <img src="/assets/HeadIcon.jpg" class="author-avatar" alt="Avatar" />
I am wnagzihxa1n, an unknown iOS/Android security researcher, this blog is my security study notes, just share something interesting.

</div>


<div class="post">
  <h1 class="post-title">大土豆安全笔记 2020.07.17 OPPO的移动安全团队很不错</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/security_daily/">security_daily</a>
      
  </div>
  
  <div class="post-date">Published on 17 Jul 2020</div>
  
  <p>我最近学习到一个新姿势，在Android应用里进行XSS攻击</p>

<p>《Finding an XSS in an HTML-based Android application》</p>
<ul>
  <li>https://labs.detectify.com/2015/02/20/finding-an-xss-in-an-html-based-android-application/</li>
</ul>

<p>有的时候我在想，我做的这个方向在目前来看，也就这样了</p>

<p>不研究新的攻击点，迟早凉凉</p>

<p>我真怀念三年前的360，那会儿大楼顶层的牌子在，一起搞技术的好基友们在，安全团队和业务的地位是平等的，指导我工作的领导是懂技术的，提的需求都是合理的，我们可以站在同一个领域的技术栈上讨论问题</p>

<p>…</p>

<p>Android 11出Beta 2了，有多少读者还没有摸过Android 10？</p>
<ul>
  <li>https://android-developers.googleblog.com/2020/07/android-11-beta-2-and-platform-stability.html</li>
</ul>

<p>新版本即是机会，大佬求带！！！</p>

<p>我接下来想买一些国产手机，多玩玩一些新功能，挖一些国产手机厂商定制系统功能引入的漏洞</p>

<p>偶然间发现OPPO的移动安全团队很不错，推荐他们写的三篇文章，我学习完也是有不少收获</p>

<p>《Android中的特殊攻击面（一）—— 邪恶的对话框》</p>
<ul>
  <li>https://mp.weixin.qq.com/s/mN5M9-P0g6x_4NqTKbO2Sg</li>
</ul>

<p>《Android中的特殊攻击面（二）—— 危险的deeplink》</p>
<ul>
  <li>https://mp.weixin.qq.com/s/81Lq-JwASnkSS2wg62HSvA</li>
</ul>

<p>《Android中的特殊攻击面（三）—— 隐蔽的call函数》</p>
<ul>
  <li>https://mp.weixin.qq.com/s/SAhXsCHvAct_2SxCXd2w0Q</li>
</ul>

<p>他们和港中大，SMU一起搞的一篇Paper：《Understanding Android VoIP Security : A System-level Vulnerability Assessment》</p>
<ul>
  <li>https://daoyuan14.github.io/papers/TR19_VoIPFuzzing.pdf</li>
  <li>https://www.youtube.com/watch?v=GFGUJiUTFtE</li>
</ul>

<p>我这周粗读了一下，收获颇丰，还有待精读以及跟进代码实践，论文写的很实在，没有那种<code class="language-plaintext highlighter-rouge">加入祖传秘制老卤</code>之类的文字，完全可以上手操作</p>

<p>作者首先描述了Android VoIP的协议栈以及攻击面，然后介绍了所使用的Fuzz方法，本地API和Intent，远程通过修改数据包的字段，再结合代码审计</p>

<p>整体产出还是很不错的</p>

<p><img src="/assets/resources/0D8BCB78F8E11EABEE712D331940DF84.jpg" alt="IMAGE" /></p>

<p>国产的手机定制这么深入，可以搞一波了，墙裂推荐有兴趣的读者朋友学习这篇Paper！</p>

<p>检测应用是否运行在虚拟容器里，这个虚拟容器不是沙箱的意思，是指多开助手之类的软件，模拟Android系统环境让应用在其内部运行</p>
<ul>
  <li>https://github.com/su-vikas/conbeerlib/blob/master/android_virtual_containers_slides.pdf</li>
  <li>https://github.com/su-vikas/conbeerlib</li>
</ul>

<p>一个类似OLLVM的东西，但有一些新功能，有点意思</p>
<ul>
  <li>https://github.com/emc2314/YANSOllvm</li>
</ul>

<p>搜索APK所有导出且没有权限的组件，这个其实搜的不全面，使用<code class="language-plaintext highlighter-rouge">registerReceiver()</code>动态注册的广播接收器默认是导出的</p>
<ul>
  <li>https://github.com/mzfr/slicer</li>
</ul>

<p>MX Player路径穿越漏洞导致的代码执行，这个漏洞我觉得很有启发，它并非单纯的解压缩导致的文件路径穿越，而是通过远程数据交互来实现的</p>
<ul>
  <li>https://medium.com/tenable-techblog/android-mx-player-path-traversal-to-code-execution-9134b623eb34</li>
</ul>

<p>简单来说，MX Player有一个文件分享的功能，正常的数据包格式如下</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mx\x00\x01\x00\x02\x00\x00\x00\xb5
{
    "hash":"FA730A013D17D705CAF504B5CA560501",
    "id":0,
    "name":"cool_video",
    "suffix":"mp4",
    "size":5976,
    "type":0
}
</code></pre></div></div>

<p>在处理数据包的时候，会直接获取包里的<code class="language-plaintext highlighter-rouge">"name"</code>字段进行路径拼接生成文件</p>

<p><img src="/assets/resources/2DCC629802261348C0DCD8C7FD155459.jpg" alt="IMAGE" /></p>

<p>所以构造如下数据包，就会造成路径穿越</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mx\x00\x01\x00\x02\x00\x00\x00\xb5
{
    "hash":"FA730A013D17D705CAF504B5CA560501",
    "id":0,
    "name":"../cool_video",
    "suffix":"mp4",
    "size":5976,
    "type":0
}
</code></pre></div></div>

<p>如何通过路径穿越实现代码执行呢？</p>

<p>常见情况下就是覆盖一个可执行文件，尤其是那种应用启动的时候会自动运行的那种，但是这个漏洞只能创建，不能覆写，所以需要想一个新方法</p>

<p>作者使用的是监控应用启动时所有文件加载操作，最后监控到了一个不存在的<code class="language-plaintext highlighter-rouge">audience_network.odex</code>文件加载</p>

<p><img src="/assets/resources/037CDB6BF2A15E0FC742EFBE54A83927.jpg" alt="IMAGE" /></p>

<p>基本的原理是ART虚拟机运行时会加载如下路径的文件</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;appPath&gt;/files/oat/&lt;arch&gt;/*.odex
</code></pre></div></div>

<p>所以往这个路径下写<code class="language-plaintext highlighter-rouge">audience_network.odex</code>即可</p>

<p>多年以前，海豚浏览器也被爆出类似的漏洞，同样是路径穿越，同样导致代码执行</p>

<p>漏洞发生的功能是还原备份</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private void c(File file, String arg8) throws myException {
    CipherInputStream cipherInputStream_1;
    ZipInputStream zipInputStream;  // 解密后的数据类型转为ZipInputStream
    BufferedInputStream bufferedInputStream_1;
    CipherInputStream cipherInputStream_2;  // 解密传入的数据流
    BufferedInputStream bufferedInputStream_2;  // 将文件读入缓冲区流
    Closeable closeable = null;
    try {
        if(!file.exists()) {
            throw new e();
        }
        this.a();  // cipher = "AES/ECB/PKCS5PADDING"
        bufferedInputStream_2 = new BufferedInputStream(new FileInputStream(file));  // 将文件读入缓冲区流
    }
    try {
        if(TextUtils.isEmpty(((CharSequence)arg8))) {
            arg8 = "3d6b27465424597a55443e7532";  // 加密秘钥，可以由用户传入，若用户不传入，则由默认秘钥加密
        }
        this.cipher.init(2, this.b(arg8));  // 用秘钥初始化cipher，秘钥为b("3d6b27465424597a55443e7532")的值
        b.a(((InputStream)bufferedInputStream_2), this.cipher);  // 仿佛在做CRC32校验
        cipherInputStream_2 = new CipherInputStream(((InputStream)bufferedInputStream_2), this.cipher);  // 解密传入的数据流
    }
    try {
        zipInputStream = new ZipInputStream(((InputStream)cipherInputStream_2));  // 解密后的数据类型转为ZipInputStream
    }
    try {
        File selfMainFile = new File(this.context.getApplicationInfo().dataDir);  // 获取程序主目录
        while(true) {
            ZipEntry zipEntry = zipInputStream.getNextEntry();
            if(zipEntry == null) {
                break;
            }
            BufferedOutputStream bufferedOutputStream = new BufferedOutputStream(new FileOutputStream(new File(selfMainFile + File.separator + zipEntry.getName())));  // 拼接解压目录，此处校验文件名，可造成路径穿越漏洞
            IOUtilities.copy(((InputStream)zipInputStream), ((OutputStream)bufferedOutputStream));  // 拷贝数据
            bufferedOutputStream.flush();  // 刷新缓冲区，将数据写出到文件
            bufferedOutputStream.close();
            zipInputStream.closeEntry();
        }
    }
    try {
        IOUtilities.closeStream(((Closeable)zipInputStream));
    }
    return;
}
</code></pre></div></div>

<p>利用方式比较常规，覆写了一个应用启动时自动加载的二进制文件<code class="language-plaintext highlighter-rouge">watch_server</code>，当应用重启即可造成代码执行</p>

<p>这两个漏洞单独写分析跟大家分享其中的代码细节，其中的漏洞模型完全可复用</p>

<p>今年MOSEC有一个我很感兴趣的议题，想去听一听，还是那个老想法，想自己搞一个Fuzzer，一直跑的那种</p>

<p><img src="/assets/resources/4A45B5EC5F5EB542AE0BDA0052A1BA62.jpg" alt="IMAGE" /></p>

<p>别的人有钱之后都是会所嫩模，我想好了，我要是赚够了钱，我就可以不上班，天天在家里研究技术</p>

<p>可惜了，我现在做着业务安全，离安全研究的道路越来越远，可能再也回不去了</p>

<p>也可能，我下个月就去搞技术研究了呢？</p>

<p>Alpha Team发现了UOS两个漏洞，官方给了致谢，很强！</p>

<p>侧面可以看出来数字公司的某些业务方向，我想搜一下这个SRC，一直搜不出来，奇了怪了</p>

<p>最后介绍一个工具，Android和iOS双平台渗透虚拟机</p>
<ul>
  <li>https://mobexler.com/</li>
</ul>

<p>一共有两个版本，官方推荐使用MobexlerLite</p>

<ol>
  <li>MobexlerLite
    <ol>
      <li>Linux Lite</li>
      <li>(OVA) File Size: 7 GB</li>
    </ol>
  </li>
  <li>Mobexler
    <ol>
      <li>Elementary OS</li>
      <li>(OVA) File Size: 17 GB</li>
    </ol>
  </li>
</ol>

<p>官方的使用图片很酷炫，颇有技术大佬的感觉</p>

<p><img src="/assets/resources/85DFAFED355E93B13EA39F98F1DEAE01.jpg" alt="IMAGE" /></p>

<p>我运行看了看，配备了一些常见的工具，部分工具和我日常工作有交集，但是我偏向JEB更多，极其少直接使用baksmali这样的工具，起码也是做了一层封装更加可视化，enjarify和jadx我觉得应该放到AndroidZone里，毕竟都是Android工具</p>

<p><img src="/assets/resources/CEF3A99E90524B64DE6531231071B05F.jpg" alt="IMAGE" /></p>

<p>不好用，我打算自己定制一个顺手的</p>

<p>…</p>

<p>我被这两天的过山车震出内伤了，周末缓缓</p>

</div>


<div class="comments">
<div id="disqus_thread"></div>
<script>
 var disqus_config = function () {
     this.page.url = 'http://localhost:4000/2020/07/17/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2020.07.17.html';
     this.page.identifier = '/2020/07/17/大土豆安全笔记 2020.07.17';
     this.page.title = '大土豆安全笔记 2020.07.17 OPPO的移动安全团队很不错';
 };

 (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
     var d = document, s = d.createElement('script');

     s.src = '//wnagzihxa1n-github-io.disqus.com/embed.js';

     s.setAttribute('data-timestamp', +new Date());
     (d.head || d.body).appendChild(s);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

</div>




<div class="related">
  <h2>related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2021/01/22/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2021.01.22.html">
            大土豆安全笔记 2021.01.22 在线求团购*OS Internals III
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2021/01/15/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2021.01.15.html">
            大土豆安全笔记 2021.01.15 您已本分
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2021/01/08/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2021.01.08.html">
            大土豆安全笔记 2021.01.08 我，零基础，学iOS macOS安全
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>all tags</h2>
  <div class="tag-cloud"><a href="/tag/android_application_security/" class="set-1">android_application_security</a> <a href="/tag/android_ctf/" class="set-3">android_ctf</a> <a href="/tag/browser_security/" class="set-4">browser_security</a> <a href="/tag/security_daily/" class="set-5">security_daily</a></div>
  




<script>
  let i = 0;
  const text = '';
  const speed = parseInt('50');
  
  function typeWriter() {
    if (i < text.length) {
      document.getElementById('animated-post-description').innerHTML += text.charAt(i);
      i++;
      setTimeout(typeWriter, speed);
    }
  }

  document.getElementById('animated-post-description').style.display = 'initial';
  typeWriter();
</script>

      </div>
    </main><footer class="site-footer">
  <div class="wrapper">
    <div class="credits"><div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked />
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
const theme = localStorage.getItem('theme');

if (theme === "light") {
    document.documentElement.setAttribute('data-theme', 'light');
} else {
    document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

function activateDarkTheme() {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
	window.localStorage.setItem('theme', 'dark');
}

function activateLightTheme() {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
	window.localStorage.setItem('theme', 'light');
}

if (theme === "dark") {
    activateDarkTheme();
} else if (theme === "light") {
    activateLightTheme();
} else if  (userPrefers === "light") {
    activateDarkTheme();
} else {
    activateDarkTheme();
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    activateLightTheme();
	} else {
	    activateDarkTheme();
	}
}
</script></div>
  </div>
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
