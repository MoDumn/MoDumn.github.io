<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>大土豆安全笔记 2020.07.06 活过来了 | wnagzihxa1n’s blog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="大土豆安全笔记 2020.07.06 活过来了" />
<meta name="author" content="wnagzihxa1n" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="整个六月一共发了七篇文章，六月初的时候我尝试了一下日更安全笔记，结果是失败了" />
<meta property="og:description" content="整个六月一共发了七篇文章，六月初的时候我尝试了一下日更安全笔记，结果是失败了" />
<link rel="canonical" href="http://localhost:4000/2020/07/06/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2020.07.06.html" />
<meta property="og:url" content="http://localhost:4000/2020/07/06/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2020.07.06.html" />
<meta property="og:site_name" content="wnagzihxa1n’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-06T20:40:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="大土豆安全笔记 2020.07.06 活过来了" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"wnagzihxa1n"},"@type":"BlogPosting","description":"整个六月一共发了七篇文章，六月初的时候我尝试了一下日更安全笔记，结果是失败了","url":"http://localhost:4000/2020/07/06/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2020.07.06.html","headline":"大土豆安全笔记 2020.07.06 活过来了","dateModified":"2020-07-06T20:40:00+08:00","datePublished":"2020-07-06T20:40:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/07/06/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2020.07.06.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="wnagzihxa1n's blog" /></head>
<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">wnagzihxa1n&#39;s blog<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        <a class="color-cyan-hover" href="https://twitter.com/wnagzihxa1n"><i class="fab fa-twitter-square"></i></a><a class="color-purple-hover" href="https://github.com/wnagzihxa1n"><i class="fab fa-github-square"></i></a>
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        
  <div class="author-box">
    
    <img src="/assets/HeadIcon.jpg" class="author-avatar" alt="Avatar" />
I am wnagzihxa1n, an unknown iOS/Android security researcher, this blog is my security study notes, just share something interesting.

</div>


<div class="post">
  <h1 class="post-title">大土豆安全笔记 2020.07.06 活过来了</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/security_daily/">security_daily</a>
      
  </div>
  
  <div class="post-date">Published on 06 Jul 2020</div>
  
  <p>整个六月一共发了七篇文章，六月初的时候我尝试了一下日更安全笔记，结果是失败了</p>

<p>安全是一个需要耐心研究的领域，保持每天产出高质量原创内容有点难，所以我恢复了之前每周五更新本周的安全笔记，我要保证文章的质量</p>

<p>没发文的大半个月里我在做两件事情，重点在写一个移动端应用审计工具，主要是逻辑漏洞，然后研究一些其它领域的逻辑漏洞，扩展思路</p>

<p>最近一些不错的技术文章，学习完后感觉获益颇丰，跟各位分享一下自己的心得</p>

<p>TSRC出品的《红蓝对抗之Windows内网渗透》</p>
<ul>
  <li>https://security.tencent.com/index.php/blog/msg/154</li>
</ul>

<p>从红蓝对抗的角度来说我应该属于蓝军，不过职责并不在这种内网渗透领域，这篇文章我学习完后感觉非常好，讲的极其详细，其中提到的一些点我感觉可以应用在日常审计中</p>

<p>如果之后产出较为不错，我会使用其它厂商的应用作为例子讲解一些实战操作</p>

<p>搞移动端业务安全，一定要深入业务场景，脱离业务场景的审计肯定是走不远的，漏洞只会掩盖在应用加固和代码混淆下面，迟早有一天会被人从冰下面挖出来吊打</p>

<p>《Almost 300 Windows 10 executables vulnerable to DLL hijacking》</p>
<ul>
  <li>https://www.bleepingcomputer.com/news/security/almost-300-windows-10-executables-vulnerable-to-dll-hijacking/</li>
</ul>

<p>最近Windows平台的DLL劫持漏洞文章突然就多了起来</p>

<p>我想了想，这种漏洞在Android端好像是没有，但是像<code class="language-plaintext highlighter-rouge">LoadLibary()</code>和<code class="language-plaintext highlighter-rouge">LoadLibraryEx()</code>这样的倒是有</p>

<p>Android平台加载Dex文件是使用类<code class="language-plaintext highlighter-rouge">DexClassLoader</code>，加载So文件是使用<code class="language-plaintext highlighter-rouge">System.loadLibrary()</code>，这两个都是指定路径去加载文件</p>

<p>可能存在的风险比如目标文件在SDCard可全局读写导致被劫持替换，加载的时候如果没有做好哈希校验就容易出现任意代码执行</p>

<p>《Automating DLL Hijack Discovery》</p>
<ul>
  <li>https://posts.specterops.io/automating-dll-hijack-discovery-81c4295904b0</li>
</ul>

<p>《Hijacking DLLs in Windows》</p>
<ul>
  <li>https://www.wietzebeukema.nl/blog/hijacking-dlls-in-windows</li>
</ul>

<p>不怕被大家笑话，我现在产出少了就会慌，看着其他师傅们每月各种致谢，动不动几十万刀的Bounty，说不羡慕是不可能的</p>

<p>所以手里有一些闲置计算资源的时候就会弄一些Fuzzer跑跑，万一就踩中了一个RCE呢？</p>

<p>我其实不是很喜欢DLL劫持这样的漏洞，我喜欢那种利用系统服务提供的接口，通过低权限进程给高权限进程发消息执行一些非预期行为</p>

<p>《CVE-2020-7454: KILLING TWO BIRDS WITH ONE BUG IN LIBALIAS》</p>
<ul>
  <li>https://www.thezdi.com/blog/2020/6/29/cve-2020-7454-killing-two-systems-with-one-bug-in-libalias</li>
</ul>

<p>libalias是一个第三方库，用来给IP包进行<code class="language-plaintext highlighter-rouge">aliasing</code>和<code class="language-plaintext highlighter-rouge">de-aliasing</code>，CVE-2020-7454存在于函数<code class="language-plaintext highlighter-rouge">AliasHandleUdpNbtNS()</code>，它会获取一个<code class="language-plaintext highlighter-rouge">pmax</code>字段，该字段直接根据偏移从数据包内获取</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AliasHandleUdpNbtNS(...) 
{
    /* ... snip ... */
    /* Calculate data length of UDP packet */ 
    uh = (struct udphdr *) ip_next(pip); 
    nsh = (NbtNSHeader *) udp_next(uh); 
    p = (u_char *) (nsh + 1); 
    pmax = (char *)uh + ntohs(uh-&gt;uh_ulen); /* &lt;--- (1) */  
    
    /* ... snip ... */
    if (ntohs(nsh-&gt;ancount) != 0) { 
        p = AliasHandleResource(ntohs(nsh-&gt;ancount), (NBTNsResource *) p, pmax, &amp;nbtarg); 
    } 
    /* ... snip ... */
}
</code></pre></div></div>

<p>然后<code class="language-plaintext highlighter-rouge">pmax</code>传入<code class="language-plaintext highlighter-rouge">AliasHandleResource()</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AliasHandleResource(..., char *pmax, ...) 
{ 
    /* ... snip ... */
        switch (ntohs(q-&gt;type)) { 
        case RR_TYPE_NB: 
            q = (NBTNsResource *) AliasHandleResourceNB(q, pmax, nbtarg); 
            break; 
    /* ... snip ... */ 
}
</code></pre></div></div>

<p>再传入<code class="language-plaintext highlighter-rouge">AliasHandleResourceNB()</code>，<code class="language-plaintext highlighter-rouge">(2)</code>循环判断的时候没判断<code class="language-plaintext highlighter-rouge">pmax</code>长度，导致<code class="language-plaintext highlighter-rouge">(3)</code>越界访问了，<code class="language-plaintext highlighter-rouge">(4)</code>还可以越界写</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AliasHandleResourceNB(..., char *pmax, ...) 
{ 
    /* ... snip ... */
    while (nb != NULL &amp;&amp; bcount != 0) { 
        if ((char *)(nb + 1) &gt; pmax) { /* &lt;--- (2) */
            nb = NULL; 
            break; 
        } 
        if (!bcmp(&amp;nbtarg-&gt;oldaddr, &amp;nb-&gt;addr, sizeof(struct in_addr))) { /* &lt;--- (3)  /
            /* ... snip ... */ 
            nb-&gt;addr = nbtarg-&gt;newaddr; /* &lt;--- (4) */
        } 
        /* ... snip ... */
        nb = (NBTNsRNB *) ((u_char *) nb + SizeOfNsRNB); 
    } 
}
</code></pre></div></div>

<p>ZDI这个代码标识非常漂亮，该省的省，清晰明了，我要好好学习一下</p>

<p>《FANS: Fuzzing Android Native System Services via Automated Interface Analysis》</p>
<ul>
  <li>https://www.usenix.org/system/files/sec20fall_liu_prepub.pdf</li>
</ul>

<p>接下来我搞一下Android的系统服务，大概的研究方式和大佬是类似的，不过我不是去Fuzz，而是找到所有的接口之后，去做路径搜索，找一些敏感的行为操作，这个路径搜索可以参考k0师傅之前写过的一篇文章《A SIMPLE STORY OF DSSVC, “LIVE AND DIE”》</p>
<ul>
  <li>https://whereisk0shl.top/post/a-simple-story-of-dssvc</li>
</ul>

<p>Always k0shl！</p>

<p>我也写了一个类似Jandroid的工具，可惜F-Secure那群人已经发了，我的就不开源了</p>

<p>最后推荐一篇奇安信的文章《“道贼”SDK：揭秘操控数百万Android手机的恶意营销插件》，对门的报告输出能力确实很好</p>
<ul>
  <li>https://mp.weixin.qq.com/s/zjG3zlJo1dSSb2mjY9QxDA</li>
</ul>

<p>我一直想搞一个像这种样本大数据监控的系统，后面的扫描引擎实现难度其实不大，基于经验编写规则即可</p>

<p>我目前遇到的一个难点在于不知道如何建立一个大数据搜索系统</p>

<p>比如现在有一百万个应用，我需要先对其进行规则扫描，这个规则扫描可以基于很多方式，尽可能的获取其行为，并且做好存储</p>

<p>然后对扫描出来的数据做大数据分析，比如关键函数调用，对同一个执行路径做归类</p>

<p>以下面这个举例，我们可以搜索出大量拥有类似调用路径的不同SDK</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>com.evil.sdk.a.b.c-&gt;a()-&gt;b()-&gt;loadLibrary()
</code></pre></div></div>

<p>再对每一个SDK进行深入分析，比如数据流分析，看加载的文件来自哪里，从本地解密释放的，还是从服务器动态下载的</p>

<p>或者可以把包含同一个SDK的应用进行批量动态分析，补充动态行为，尤其是加载的插件行为</p>

<p>以上这一段只是我个人的想法，跟业界大佬们成熟的实现方案相比只是一个没牌面的玩具，如果有机会可以真正参与玩一把，我还是很乐意的</p>

<p>我不是想加入国家队，我喜欢自由，每天九点上班六点下班那种</p>

<p>最近股市行情不错，跑步入场吧</p>

</div>


<div class="comments">
<div id="disqus_thread"></div>
<script>
 var disqus_config = function () {
     this.page.url = 'http://localhost:4000/2020/07/06/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2020.07.06.html';
     this.page.identifier = '/2020/07/06/大土豆安全笔记 2020.07.06';
     this.page.title = '大土豆安全笔记 2020.07.06 活过来了';
 };

 (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
     var d = document, s = d.createElement('script');

     s.src = '//wnagzihxa1n-github-io.disqus.com/embed.js';

     s.setAttribute('data-timestamp', +new Date());
     (d.head || d.body).appendChild(s);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

</div>




<div class="related">
  <h2>related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2021/01/22/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2021.01.22.html">
            大土豆安全笔记 2021.01.22 在线求团购*OS Internals III
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2021/01/15/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2021.01.15.html">
            大土豆安全笔记 2021.01.15 您已本分
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2021/01/08/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2021.01.08.html">
            大土豆安全笔记 2021.01.08 我，零基础，学iOS macOS安全
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>all tags</h2>
  <div class="tag-cloud"><a href="/tag/android_application_security/" class="set-1">android_application_security</a> <a href="/tag/android_ctf/" class="set-3">android_ctf</a> <a href="/tag/browser_security/" class="set-4">browser_security</a> <a href="/tag/security_daily/" class="set-5">security_daily</a></div>
  




<script>
  let i = 0;
  const text = '';
  const speed = parseInt('50');
  
  function typeWriter() {
    if (i < text.length) {
      document.getElementById('animated-post-description').innerHTML += text.charAt(i);
      i++;
      setTimeout(typeWriter, speed);
    }
  }

  document.getElementById('animated-post-description').style.display = 'initial';
  typeWriter();
</script>

      </div>
    </main><footer class="site-footer">
  <div class="wrapper">
    <div class="credits"><div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked />
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
const theme = localStorage.getItem('theme');

if (theme === "light") {
    document.documentElement.setAttribute('data-theme', 'light');
} else {
    document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

function activateDarkTheme() {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
	window.localStorage.setItem('theme', 'dark');
}

function activateLightTheme() {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
	window.localStorage.setItem('theme', 'light');
}

if (theme === "dark") {
    activateDarkTheme();
} else if (theme === "light") {
    activateLightTheme();
} else if  (userPrefers === "light") {
    activateDarkTheme();
} else {
    activateDarkTheme();
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    activateLightTheme();
	} else {
	    activateDarkTheme();
	}
}
</script></div>
  </div>
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
