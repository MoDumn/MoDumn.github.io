<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>2014 NAGA&amp;PIOWIND APP应用攻防竞赛 - crackme.l3.sign | wnagzihxa1n’s blog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="2014 NAGA&amp;PIOWIND APP应用攻防竞赛 - crackme.l3.sign" />
<meta name="author" content="wnagzihxa1n" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="一开始用模拟器跑起来就崩溃，我以为是模拟器系统版本的问题，后来看了配置文件，发现没有问题，猜测可能是有反调试，第三题了应该出现反调试了" />
<meta property="og:description" content="一开始用模拟器跑起来就崩溃，我以为是模拟器系统版本的问题，后来看了配置文件，发现没有问题，猜测可能是有反调试，第三题了应该出现反调试了" />
<link rel="canonical" href="http://localhost:4000/2017/09/07/2014-NAGA&PIOWIND-APP%E5%BA%94%E7%94%A8%E6%94%BB%E9%98%B2%E7%AB%9E%E8%B5%9B-crackme.l3.sign.html" />
<meta property="og:url" content="http://localhost:4000/2017/09/07/2014-NAGA&PIOWIND-APP%E5%BA%94%E7%94%A8%E6%94%BB%E9%98%B2%E7%AB%9E%E8%B5%9B-crackme.l3.sign.html" />
<meta property="og:site_name" content="wnagzihxa1n’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-09-07T20:40:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="2014 NAGA&amp;PIOWIND APP应用攻防竞赛 - crackme.l3.sign" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"wnagzihxa1n"},"@type":"BlogPosting","description":"一开始用模拟器跑起来就崩溃，我以为是模拟器系统版本的问题，后来看了配置文件，发现没有问题，猜测可能是有反调试，第三题了应该出现反调试了","url":"http://localhost:4000/2017/09/07/2014-NAGA&PIOWIND-APP%E5%BA%94%E7%94%A8%E6%94%BB%E9%98%B2%E7%AB%9E%E8%B5%9B-crackme.l3.sign.html","headline":"2014 NAGA&amp;PIOWIND APP应用攻防竞赛 - crackme.l3.sign","dateModified":"2017-09-07T20:40:00+08:00","datePublished":"2017-09-07T20:40:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2017/09/07/2014-NAGA&PIOWIND-APP%E5%BA%94%E7%94%A8%E6%94%BB%E9%98%B2%E7%AB%9E%E8%B5%9B-crackme.l3.sign.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="wnagzihxa1n's blog" /></head>
<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">wnagzihxa1n&#39;s blog<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        <a class="color-cyan-hover" href="https://twitter.com/wnagzihxa1n"><i class="fab fa-twitter-square"></i></a><a class="color-purple-hover" href="https://github.com/wnagzihxa1n"><i class="fab fa-github-square"></i></a>
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        
  <div class="author-box">
    
    <img src="/assets/HeadIcon.jpg" class="author-avatar" alt="Avatar" />
I am wnagzihxa1n, an unknown iOS/Android security researcher, this blog is my security study notes, just share something interesting.

</div>


<div class="post">
  <h1 class="post-title">2014 NAGA&PIOWIND APP应用攻防竞赛 - crackme.l3.sign</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/android_ctf/">android_ctf</a>
      
  </div>
  
  <div class="post-date">Published on 07 Sep 2017</div>
  
  <p>一开始用模拟器跑起来就崩溃，我以为是模拟器系统版本的问题，后来看了配置文件，发现没有问题，猜测可能是有反调试，第三题了应该出现反调试了</p>

<p>于是使用调试模式启动应用</p>

<p>先修改<code class="language-plaintext highlighter-rouge">android_server</code>的名称和监听端口</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@generic:/data/local/tmp # ./as -p23333
</code></pre></div></div>

<p>相应的端口转发也要修改</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\Luyu&gt;adb forward tcp:23946 tcp:23333
</code></pre></div></div>

<p>然后调试模式启动</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb shell am start -D -n com.crackme/.MainActivity
</code></pre></div></div>

<p>开启DDMS，选中待调试的应用，前面出现小虫子</p>

<p>然后输入</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\Luyu&gt;jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8700
设置未捕获的java.lang.Throwable
设置延迟的未捕获的java.lang.Throwable
正在初始化jdb...
&gt;
</code></pre></div></div>

<p>如果出现如下信息，先关掉Android Studio等玩意</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\Luyu&gt;jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8700
java.net.ConnectException: Connection refused: connect
        at java.net.DualStackPlainSocketImpl.connect0(Native Method)
        at java.net.DualStackPlainSocketImpl.socketConnect(DualStackPlainSocketImpl.java:79)
        at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)
        at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)
        at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)
        at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:172)
        at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)
        at java.net.Socket.connect(Socket.java:589)
        at com.sun.tools.jdi.SocketTransportService.attach(SocketTransportService.java:222)
        at com.sun.tools.jdi.GenericAttachingConnector.attach(GenericAttachingConnector.java:116)
        at com.sun.tools.jdi.SocketAttachingConnector.attach(SocketAttachingConnector.java:90)
        at com.sun.tools.example.debug.tty.VMConnection.attachTarget(VMConnection.java:519)
        at com.sun.tools.example.debug.tty.VMConnection.open(VMConnection.java:328)
        at com.sun.tools.example.debug.tty.Env.init(Env.java:63)
        at com.sun.tools.example.debug.tty.TTY.main(TTY.java:1082)

致命错误:
无法附加到目标 VM。
</code></pre></div></div>

<p>修改调试选项，然后使用IDA attach</p>

<p><img src="/assets/resources/1098ADA7B554FCDE0F477ED5A2D8DA91.png" alt="1.png" /></p>

<p>挂上去后，点击运行，或者F9，断在ELF的入口</p>

<p><img src="/assets/resources/6FEC6AB80F61B9E4F77EC583DC947D2A.png" alt="2.png" /></p>

<p>按照前两题的方法dump解密后的so即可</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>auto fp, dex_addr, end_addr;  
fp = fopen("E:\\libcrackme.so", "wb");  
for(dex_addr = 0xA33AC000; dex_addr &lt; 0xA3406000; dex_addr++)
    fputc(Byte(dex_addr), fp);
</code></pre></div></div>

<p>文件头依旧是空的，使用正常的ELF文件头覆盖回去，使用IDA打开，找到<code class="language-plaintext highlighter-rouge"> _Z9fdog_initv</code>，这里实现了反调试</p>

<p><img src="/assets/resources/498EFB365FF6DD6C40D43077284A2AC1.png" alt="3.png" /></p>

<p>跟入该函数，该函数创建了很多的子线程进行反调试，我们一个个跟</p>

<p><img src="/assets/resources/A5A58A49602207AB31764C6B18C5C4E1.png" alt="4.png" /></p>

<p>这里有一个问题，创建子线程时的函数地址是动态调试时内存的地址，如果不清楚我们看伪代码</p>

<p><img src="/assets/resources/6A198B5C3CC47FAD8A85A9FA7F9ED05E.png" alt="5.png" /></p>

<p>所有子线程的函数参数全是内存地址，有两种方法，第一种是动态调试，但是需要过掉反调试，第二种方法，可以看到我在上面的截图里已经体现出来了，so加载到内存里的地址一般都是<code class="language-plaintext highlighter-rouge">0x*****000</code>，所以我们可以根据地址的后三位来搜索函数，而且IDA识别函数后会将函数命名为<code class="language-plaintext highlighter-rouge">sub_****</code>，而且有地址的偏移等信息</p>

<p>那么我们来一个个找</p>

<p>第一个函数是<code class="language-plaintext highlighter-rouge">_Z13debuggdb_scanv</code>，实现了循环检测</p>

<p><img src="/assets/resources/DA3C85C3EEC9E256AC9BD419BBAB91BF.png" alt="6.png" /></p>

<p>跟进其中调用的函数，检测的是进程名，分别检测了<code class="language-plaintext highlighter-rouge">gdb</code>，<code class="language-plaintext highlighter-rouge">gdbserver</code>，<code class="language-plaintext highlighter-rouge">android_server</code>，<code class="language-plaintext highlighter-rouge">xposed</code></p>

<p><img src="/assets/resources/517640C44ADDC20E9D15FB2BAA5699C8.png" alt="7.png" /></p>

<p>第二个函数<code class="language-plaintext highlighter-rouge">_Z26file_pro_thread_strengthenv</code>，这个函数我不知道是什么反调试操作，比较猥琐的感觉</p>

<p><img src="/assets/resources/A131DF4ECE6D399B1DD952EFDA482F41.png" alt="8.png" /></p>

<p>先放着，我找其他师傅再问问</p>

<p>第三个函数<code class="language-plaintext highlighter-rouge">_Z18prevent_attach_onev</code>，看起来好像是调用了上了锁的函数的样子</p>

<p><img src="/assets/resources/68D249F50E4510F32EA56ABDC75F09A5.png" alt="9.png" /></p>

<p>这个函数读取了进程的<code class="language-plaintext highlighter-rouge">/proc/%d/task/%s/stat</code>文件夹</p>

<p><img src="/assets/resources/BB4DB84C4581D49C104DD1E556C2D6B2.png" alt="10.png" /></p>

<p>判断了标志位</p>

<p><img src="/assets/resources/078D0174288A3D22C463E53A0EF6263E.png" alt="11.png" /></p>

<p>第四个函数<code class="language-plaintext highlighter-rouge">_Z18prevent_attach_twov</code>好像也是调用了上了锁的函数</p>

<p><img src="/assets/resources/6442363E81D8A1B9F39752CF1C984C8B.png" alt="12.png" /></p>

<p>反调试部分大概就是这样</p>

<p>接下来我们来看校验部分</p>

<p><img src="/assets/resources/C0071816F849A5155C831835422527E6.png" alt="13.png" /></p>

<p>进入校验，先初始化内存空间存储用户名和注册码，然后进入校验</p>

<p><img src="/assets/resources/CF11BBEC596863034A112C03AE1FE063.png" alt="14.png" /></p>

<p>三处<code class="language-plaintext highlighter-rouge">-</code>判断，然后进入校验</p>

<p><img src="/assets/resources/C9B3040DB4F3231178ADAD698836CD7F.png" alt="15.png" /></p>

<p>变量的初始化</p>

<p><img src="/assets/resources/7FB63E6397C75B3F256C9E8D7FC0C024.png" alt="16.png" /></p>

<p>将解码后的数据前<code class="language-plaintext highlighter-rouge">n - 2</code>位进行奇数位和偶数位的交换</p>

<p><img src="/assets/resources/13127DAB8935D51FBB3EC5E0329FA4D4.png" alt="17.png" /></p>

<p>最后正常对比</p>

<p><img src="/assets/resources/B1466BD6D40C44B5C5B28246AB71F4C0.png" alt="18.png" /></p>

<p>最后测试</p>

<p><img src="/assets/resources/3A52AFF2D112F191D2D62383F68A461F.png" alt="19.png" /></p>

<p>注册代码</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class MyKeyGen {
    public static void main(String[] args) throws Exception {
        String userName = "wnagzihxain";
        StringBuilder re_userName = new StringBuilder();
        for (int i = 0; i &lt; userName.length() - 2; i += 2) {
            re_userName.append(userName.charAt(i + 1));
            re_userName.append(userName.charAt(i));
        }
        re_userName.append(userName.charAt(userName.length() - 1));
//        System.out.println(re_userName.toString());
        StringBuilder temp = new StringBuilder(Base64.getBase64(re_userName.toString()));
        System.out.println(temp);
        StringBuilder regCode = new StringBuilder();
        for (int i = 0; i &lt; temp.length(); i++) {
            regCode.append(temp.charAt(i));
            if (temp.charAt(i + 1) == '=') {
                break;
            }
            if ((i + 1) % 3 == 0) {
                regCode.append('-');
            }
        }
        System.out.println(regCode);
    }
}
</code></pre></div></div>

</div>


<div class="comments">
<div id="disqus_thread"></div>
<script>
 var disqus_config = function () {
     this.page.url = 'http://localhost:4000/2017/09/07/2014-NAGA&PIOWIND-APP%E5%BA%94%E7%94%A8%E6%94%BB%E9%98%B2%E7%AB%9E%E8%B5%9B-crackme.l3.sign.html';
     this.page.identifier = '/2017/09/07/2014 NAGA&PIOWIND APP应用攻防竞赛 - crackme.l3.sign';
     this.page.title = '2014 NAGA&PIOWIND APP应用攻防竞赛 - crackme.l3.sign';
 };

 (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
     var d = document, s = d.createElement('script');

     s.src = '//wnagzihxa1n-github-io.disqus.com/embed.js';

     s.setAttribute('data-timestamp', +new Date());
     (d.head || d.body).appendChild(s);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

</div>




<div class="related">
  <h2>related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2021/01/22/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2021.01.22.html">
            大土豆安全笔记 2021.01.22 在线求团购*OS Internals III
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2021/01/15/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2021.01.15.html">
            大土豆安全笔记 2021.01.15 您已本分
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2021/01/08/%E5%A4%A7%E5%9C%9F%E8%B1%86%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0-2021.01.08.html">
            大土豆安全笔记 2021.01.08 我，零基础，学iOS macOS安全
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>all tags</h2>
  <div class="tag-cloud"><a href="/tag/android_application_security/" class="set-1">android_application_security</a> <a href="/tag/android_ctf/" class="set-3">android_ctf</a> <a href="/tag/browser_security/" class="set-4">browser_security</a> <a href="/tag/security_daily/" class="set-5">security_daily</a></div>
  




<script>
  let i = 0;
  const text = '';
  const speed = parseInt('50');
  
  function typeWriter() {
    if (i < text.length) {
      document.getElementById('animated-post-description').innerHTML += text.charAt(i);
      i++;
      setTimeout(typeWriter, speed);
    }
  }

  document.getElementById('animated-post-description').style.display = 'initial';
  typeWriter();
</script>

      </div>
    </main><footer class="site-footer">
  <div class="wrapper">
    <div class="credits"><div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked />
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
const theme = localStorage.getItem('theme');

if (theme === "light") {
    document.documentElement.setAttribute('data-theme', 'light');
} else {
    document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

function activateDarkTheme() {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
	window.localStorage.setItem('theme', 'dark');
}

function activateLightTheme() {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
	window.localStorage.setItem('theme', 'light');
}

if (theme === "dark") {
    activateDarkTheme();
} else if (theme === "light") {
    activateLightTheme();
} else if  (userPrefers === "light") {
    activateDarkTheme();
} else {
    activateDarkTheme();
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    activateLightTheme();
	} else {
	    activateDarkTheme();
	}
}
</script></div>
  </div>
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
